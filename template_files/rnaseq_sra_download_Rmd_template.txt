Install the prerequisite NCBI tool kits if they do not exist
* esearch 
* efetch

Install the prerequisite R packages if they do not exist
* GEOquery (if geo_id is specified)
* dplyr
* pander

Load the necessary libraries.


```{r lib, eval=T, echo=F, message=F, warning=F}
if (exists("geo_id")){library(GEOquery)}
library(dplyr)
library(pander)
```

### Obtain raw GEO phenotype file

Obtain raw sample information including SRA ID from GEO. If pheno_fn is specified, download samples based on SRA_ID column; otherwise, download samples based on the GEO raw phenotype file.

```{r geo_download, eval=T, echo=F, message=F, warning=F}
if (exists("geo_id")){
  if (!exists("pheno_fn")) {
    geo_fn <- paste0(out_dir, geo_id, "_series_matrix.txt.gz")
    if (file.exists(geo_fn)) { # matrix files are alreadly downloaded
      gse <- getGEO(filename=geo_fn,GSEMatrix = TRUE)
    } else {
      gse <- getGEO(geo_id, destdir=out_dir, GSEMatrix = TRUE) # download matrix file
      if (length(gse)>1) {  # multiple platform
        gpls=sapply(gse,annotation)
        cat("This study was performed in multiple platforms:\n")
        cat(unname(gpls),"\n")
        cat("Samples from same platform shoud be analyzed together. Assign a platform to the variable geo_GPL in the session coding.\n")
        if (geo_GPL=="") {
          stop("This study has multiple platforms. Please assign the platform to the variable geo_GPL in the session coding.")
        } else {
          if (!geo_GPL%in%gpls) {stop("Specified platform does not exist. Please correct.")}
          cat("Use platform", geo_GPL, "\n"); idx=which(grepl(geo_GPL, gpls)); gse <- gse[[idx]]
        }
      }
      else {
        gse <- gse[[1]]
      }
    }
  }
}
```

Show expression dataset features using gse matrix
```{r gse, eval=T, echo=F}
if (exists("geo_id")){
  if (!exists("pheno_fn")) {
    gse
  }
}
```

### Raw phenotype summary

Generated a summary of all the phenotypic variables for overview.

For continuous variables, show the summary table. For categorical variables, only show the first five levels of variables.

Generate a variable, suppldata (whether supplementary data are available), based on whether the column supplementary_file is none.

```{r phenoraw_summ, eval=T, echo=F, results="asis"}
if(exists("geo_id")){
  pheno.raw <- pData(phenoData(gse))
  for (x in names(pheno.raw)) {
    vec=pheno.raw[,x]
    if (!is.numeric(vec)) {
      vec <- factor(vec)
      if (nlevels(vec)>5) {res=table(droplevels(vec[vec%in%levels(vec)[1:5]]))} else {res=table(vec)}
      res=data.frame(res)
      names(res) <- c(x,"counts")
    }
    if (is.numeric(vec)){res=summary(vec)}
    pandoc.table(res, justify='left',split.tables=Inf, caption=x)
  }
}
```

### Get SRA ftp link for samples

If pheno_fn is not defined, download samples that have SRA id from GEO raw phenotype files, otherwise, download samples from defined phenotype file.

SRA sample ID is derived from GEO phenotype where the column name with **relation** if SRA download is needed.

```{r pheno.raw, eval=T, echo=F, message=F, warning=F}
if (exists("geo_id")){
  if (!exists("pheno_fn")) {
    # identify column with SRX or Biosample ID
    relation_name <- names(pheno.raw)[apply(pheno.raw,2,function(x)any(grepl("SRX|SAMN", x)))][1]
    files <- gsub(".*=|.*/","",pheno.raw[,relation_name])
  } else {
    pheno.raw <- read.table(pheno_fn, header=T, sep='\t')
    files <- pheno.raw$SRA_ID
  }
  cat(length(files), "samples for download:", paste(files,collapse=", "),"\n")
} else {
  if (exists("pheno_fn")) {
    pheno.raw <- read.table(pheno_fn, header=T, sep='\t')
    files <- pheno.raw$SRA_ID    
  } else {
    stop("GEO ID is not provided. Please provide user defined meta-data.")
  }
}
```

Get fastq file information from SRA repository using SRA Tools. Raw .fastq files will be downloaded in parallele using Linux bash script

```{r sra_download_sradbnotexist, eval=T, echo=F, message=F, warning=F}
# obtain metadata from SRA website
metadata_fn <- paste0(out_dir, "/", sra_id, ".metadata.csv") 
cmd_metadata_download <- paste0("esearch -db sra -query ", sra_id, " | efetch -format runinfo | awk -F ',' 'NR==1; NR>1 {print $0 | \"grep -v Run\" }' | sed '/^$/d' > ", metadata_fn)
system(cmd_metadata_download)
# save meta data in sraFile.info
sraFiles <- read.csv(metadata_fn)
names(sraFiles) <- unname(sapply(names(sraFiles), tolower))
sraFiles <- sraFiles %>% dplyr::filter(experiment%in%files|biosample%in%files) %>% dplyr::select(run,submission,experiment,biosample) %>% unique() # exclude the same samples that are used in other projects
if (!exists("pheno_fn")) {
  files <- sraFiles$run # update SRR id
}
if (!exists("geo_id")) {
  sra_fn <- paste0(out_dir, project_name, "_sraFile.info")
} else {
  if (geo_GPL=="") {sra_fn <- paste0(out_dir, project_name, "_sraFile.info")} else {sra_fn <- paste0(out_dir, project_name, "_", geo_GPL, "_sraFile.info")}
}
write.table(sraFiles, sra_fn, col.names=T,row.names=F,sep="\t",quote=F )
```

Show first five rows of SRA information
```{r srainfo_show, eval=T, echo=F, message=F, warning=F, results="asis"}
row.names(sraFiles) <- NULL
pandoc.table(head(sraFiles,5), justify='left',split.tables=Inf, caption="SRA information")
```

### User tailored phenotype file

**This step is only used for tailoring raw phenotype file from GEO. This step requires mannual inspection.**

Raw phenotypic variables are not informative (e.g. description, characteristics_ch1 and source_name_ch1) and not created in a consice way. Select useful phenotype variables and manually modify them using a standard format including the following columns: Sample, GEO_ID, Donor (required column for treatment comparison), Disease, Treatment, and any other information if provided such as Age, Gender, ERCC spike-in, Sequencing index, Sample preparation kit.

The example codes for this section are based on phenotype data from GSE52778 (SRA study ID: SRP033351).

```{r choose_pheno, eval=T, echo=F, message=F, warning=F}
# define parameters to execute corresponding block
retrive_pheno_fromGEO <- (!exists("pheno_fn"))&(exists("geo_id"))
use_pheno_fn <- exists("pheno_fn")
```

```{r pheno_from_GEO, eval=retrive_pheno_fromGEO, echo=F, message=F, warning=F}
library(dplyr)
cols=c("title","geo_accession", "characteristics_ch1.2","characteristics_ch1.3", "characteristics_ch1")
if (all(sapply(cols, function(x){x%in%names(pheno.raw)}))) {
    pheno <- pheno.raw %>%
      dplyr::select(cols) %>%
      dplyr::mutate(GEO_ID=geo_accession) %>%
      dplyr::mutate(Donor=gsub("cell line: ","",characteristics_ch1.3)) %>%
      dplyr::mutate(Tissue="ASM") %>%
      dplyr::mutate(Treatment=gsub("treatment: ","",characteristics_ch1)) %>%
      dplyr::mutate(Treatment=gsub("Albuterol","alb",Treatment)) %>%
      dplyr::mutate(Treatment=gsub("Dexamethasone","dex",Treatment)) %>%
      dplyr::mutate(Treatment=gsub("Untreated","untreated",Treatment)) %>%
      dplyr::mutate(Disease="nonasthma") %>%
      dplyr::mutate(ERCC_Mix=gsub("ercc_mix: ","",characteristics_ch1.2)) %>%
      dplyr::select(-one_of(cols)) %>% # remove original columns
      dplyr::mutate(Sample=files) %>%
      dplyr::mutate_if(is.character,as.factor) 
} else {
  cat("Not all pre-defined column names are in meta data. Use raw meta data.\n")
  pheno <- pheno.raw
  pheno$SRA_ID <- files
}
pheno <- merge(unique(sraFiles[,c("run","experiment")]), pheno, by.x="run", by.y="Sample", all.y=T) # add sample name (run column from SRA database)
names(pheno)[names(pheno)%in%c("experiment")] <- c("SRA_ID")
names(pheno)[names(pheno)%in%c("run")] <- c("Sample")
detach("package:dplyr")
write.table(pheno, paste0(out_dir, geo_id, "_withoutQC.txt"),col.names=T,row.names=F,sep="\t",quote=F)
```

```{r pheno_from_file, eval=use_pheno_fn, echo=F, message=F, warning=F}
pheno <- read.table(pheno_fn, header=T, sep="\t")
```

Show the summary of phenotype variables and the sample size for different groups

```{r pheno_summ, eval=T, echo=F, message=F, warning=F, results="asis"}
# show the first five rows
if(exists("pheno_fn")|exists("geo_id")){
  pandoc.table(head(pheno,5), split.tables=Inf,caption="Show the first 5 rows of the modified phenotype file")
  # show the groups of interest
  avail_group=c("Tissue","Disease","Treatment")[c("Tissue","Disease","Treatment")%in%names(pheno)] 
  if (length(avail_group)>0) {
    res=as.data.frame(table(pheno[,avail_group]))
    names(res) <- c(avail_group,"Count")
    pandoc.table(res, split.tables=Inf, caption="Sample size in different tissue and disease/treatment groups")
  }
 }
```

#### Session information

```{r sessioninfo, echo=F}
pander(sessionInfo())
```
